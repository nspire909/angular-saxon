<div>
  <mat-form-field class="sticky-toggle-group">
    <input
      matInput
      autocomplete="off"
      [placeholder]="'Filter...'"
      [type]="'search'"
      (keyup)="applyFilter($event)"
      #input
    />
  </mat-form-field>
</div>

<section class="container mat-elevation-z8 dense-table" tabindex="0">
  <mat-sidenav-container>
    <mat-sidenav #sidenav [mode]="'over'" position="end" cdkDropListGroup>
      <div style="height: 100%">
        <ng-scrollbar>
          <div class="sticky-menu flex flex-row justify-between">
            <button mat-icon-button color="primary" (click)="resetColumns.emit()" matTooltip="Reset Columns">
              <mat-icon>undo</mat-icon>
            </button>
            <button mat-icon-button color="primary" (click)="sidenav.toggle()" matTooltip="Close Menu">
              <mat-icon>close</mat-icon>
            </button>
          </div>
          <div>
            <div cdkDropList id="pinned-left" class="column-list" (cdkDropListDropped)="drop($event)">
              <span>Pinned Left</span>
              @for (column of pinnedLeftColumns(); track column.columnDef) {
                <div class="column-item" cdkDrag>
                  <mat-icon cdkDragHandle>drag_indicator</mat-icon>
                  <mat-checkbox
                    [checked]="store.$active().get(column.columnDef)"
                    (change)="toggleColumn(column.columnDef, $event.checked)"
                    >{{ column.columnDef }}</mat-checkbox
                  >
                </div>
              }
            </div>
            <mat-divider></mat-divider>
            <div cdkDropList id="pinned-none" class="column-list" (cdkDropListDropped)="drop($event)">
              <span>Unpinned</span>
              @for (column of unpinnedColumns(); track column.columnDef) {
                <div class="column-item" cdkDrag>
                  <mat-icon cdkDragHandle>drag_indicator</mat-icon>
                  <mat-checkbox
                    [checked]="store.$active().get(column.columnDef)"
                    (change)="toggleColumn(column.columnDef, $event.checked)"
                    >{{ column.columnDef }}</mat-checkbox
                  >
                </div>
              }
            </div>
            <mat-divider></mat-divider>
            <div cdkDropList id="pinned-right" class="column-list" (cdkDropListDropped)="drop($event)">
              <span>Pinned Right</span>
              @for (column of pinnedRightColumns(); track column.columnDef) {
                <div class="column-item" cdkDrag>
                  <mat-icon cdkDragHandle>drag_indicator</mat-icon>
                  <mat-checkbox
                    [checked]="store.$active().get(column.columnDef)"
                    (change)="toggleColumn(column.columnDef, $event.checked)"
                    >{{ column.columnDef }}</mat-checkbox
                  >
                </div>
              }
            </div>
          </div>
        </ng-scrollbar>
      </div>
    </mat-sidenav>
    <mat-sidenav-content>
      <ng-scrollbar>
        <table
          mat-table
          [dataSource]="dataSource"
          [ngsxMultiSort]="options().multiSort"
          multiTemplateDataRows
          #table="matTable"
          cdkDropList
          cdkDropListOrientation="horizontal"
          (cdkDropListDropped)="tableDrop($event)"
        >
          <ng-container matColumnDef="select" [sticky]="true">
            <th mat-header-cell *matHeaderCellDef style="width: 40px">
              <mat-checkbox
                (change)="$event ? toggleAllRows() : null"
                [checked]="selection.hasValue() && isAllSelected()"
                [indeterminate]="selection.hasValue() && !isAllSelected()"
                [aria-label]="checkboxLabel()"
              >
              </mat-checkbox>
            </th>
            <td mat-cell *matCellDef="let row; table: table">
              <mat-checkbox
                (click)="$event.stopPropagation()"
                (change)="$event ? selection.toggle(row) : null"
                [checked]="selection.isSelected(row)"
                [aria-label]="checkboxLabel(row)"
              >
              </mat-checkbox>
            </td>
          </ng-container>
          <ng-container matColumnDef="select-filter" [sticky]="true">
            <th mat-header-cell *matHeaderCellDef></th>
          </ng-container>

          @for (column of columns(); track column.columnDef; let columnIndex = $index) {
            <ng-container
              [matColumnDef]="column.columnDef"
              [sticky]="column.pinned === 'left'"
              [stickyEnd]="column.pinned === 'right'"
            >
              <th
                mat-header-cell
                *matHeaderCellDef
                cdkDrag
                [cdkDragDisabled]="column.pinned === 'left' || column.pinned === 'right'"
              >
                <div class="flex flex-row justify-between items-center">
                  <ngsx-multi-sort-header #matSortHeader class="flex-1">
                    {{ column.header }}
                  </ngsx-multi-sort-header>
                  <button mat-icon-button [matMenuTriggerFor]="menu" aria-label="Example icon-button with a menu">
                    <mat-icon>more_vert</mat-icon>
                  </button>
                  <mat-menu #menu="matMenu">
                    <button mat-menu-item [matMenuTriggerFor]="sort">
                      <mat-icon>sort</mat-icon>
                      <span>Sort</span>
                    </button>
                    <mat-divider></mat-divider>
                    <button mat-menu-item [matMenuTriggerFor]="pin">
                      <mat-icon>keep</mat-icon>
                      <span>Pin Column</span>
                    </button>
                    <mat-divider></mat-divider>
                    <button mat-menu-item (click)="resetColumns.emit()">
                      <mat-icon>undo</mat-icon>
                      <span>Reset Columns</span>
                    </button>
                  </mat-menu>
                  <mat-menu #sort="matMenu">
                    @if (matSortHeader._getAriaSortAttribute() !== 'ascending') {
                      <button mat-menu-item (click)="matSortHeader.sort('ascending')">
                        <mat-icon>arrow_upward</mat-icon>
                        <span>Sort Ascending</span>
                      </button>
                    }
                    @if (matSortHeader._getAriaSortAttribute() !== 'descending') {
                      <button mat-menu-item (click)="matSortHeader.sort('descending')">
                        <mat-icon>arrow_downward</mat-icon>
                        <span>Sort Descending</span>
                      </button>
                    }
                    @if (matSortHeader._getAriaSortAttribute() !== 'none') {
                      <button mat-menu-item (click)="matSortHeader.sort('none')">
                        <mat-icon>close_small</mat-icon>
                        <span>Clear Sort</span>
                      </button>
                    }
                  </mat-menu>
                  <mat-menu #pin="matMenu">
                    <button mat-menu-item (click)="pinColumn(column)">
                      <mat-icon>{{ column.pinned !== 'left' && column.pinned !== 'right' ? 'check' : '' }}</mat-icon>
                      <span>No Pin</span>
                    </button>
                    <button mat-menu-item (click)="pinColumn(column, 'left')">
                      <mat-icon>{{ column.pinned === 'left' ? 'check' : '' }}</mat-icon>
                      <span>Pin Left</span>
                    </button>
                    <button mat-menu-item (click)="pinColumn(column, 'right')">
                      <mat-icon>{{ column.pinned === 'right' ? 'check' : '' }}</mat-icon>
                      <span>Pin Right</span>
                    </button>
                  </mat-menu>
                </div>
              </th>
              <td
                mat-cell
                *matCellDef="let row; let rowIndex = dataIndex; table: table"
                [class.none]="options().rowAction === 'none'"
                matTooltip
              >
                <a
                  [routerLink]="options().rowAction === 'link' ? 'abc' + rowIndex : null"
                  [tabindex]="columnIndex === 0 ? 0 : -1"
                  style="
                    max-width: 200px;
                    height: 100%;
                    display: flex;
                    justify-content: flex-start;
                    align-items: center;
                  "
                >
                  <span [ngsxOverflowTooltip]="!options().cellWrapping">
                    {{ column.cell(row) }}
                  </span>
                </a>
              </td>
            </ng-container>
            <ng-container
              [matColumnDef]="column.columnDef + '-filter'"
              [sticky]="column.pinned === 'left'"
              [stickyEnd]="column.pinned === 'right'"
            >
              <th mat-header-cell *matHeaderCellDef>
                @if (store.$filter; as filter) {
                  <mat-form-field>
                    <input
                      matInput
                      autocomplete="off"
                      [placeholder]="'Filter...'"
                      [type]="'search'"
                      [formControl]="filter().controls[column.columnDef]!"
                      [name]="column.columnDef"
                    />
                    <mat-error matTooltip [ngsxOverflowTooltip]><span> Required </span></mat-error>
                  </mat-form-field>
                }
              </th>
            </ng-container>
          }

          <ng-container matColumnDef="actions" [stickyEnd]="true">
            <th mat-header-cell *matHeaderCellDef style="width: 48px">
              <button mat-icon-button color="primary" (click)="sidenav.toggle()">
                <mat-icon>menu</mat-icon>
              </button>
            </th>
            <td mat-cell *matCellDef="let row; table: table">
              <!-- <button mat-icon-button disabled>
                <mat-icon>done</mat-icon>
              </button> -->
            </td>
          </ng-container>
          <ng-container matColumnDef="actions-filter" [stickyEnd]="true">
            <th mat-header-cell *matHeaderCellDef>
              <button mat-icon-button color="primary" matTooltip="Clear all filters" (click)="clearFilters()">
                <mat-icon>close</mat-icon>
              </button>
            </th>
          </ng-container>

          <!-- Expanded Content Column - The detail row is made up of this one column that spans across all columns -->
          <ng-container matColumnDef="expandedDetail">
            <td mat-cell *matCellDef="let row; table: table" [attr.colspan]="displayedColumns().length">
              <div
                class="element-detail"
                [class.hidden]="options().rowAction !== 'expand'"
                [@detailExpand]="expandedElements.includes(row.name) ? 'expanded' : 'collapsed'"
              >
                <div class="element-diagram">
                  <div class="element-position">{{ row.position }}</div>
                  <div class="element-symbol">{{ row.symbol }}</div>
                  <div class="element-name">{{ row.name }}</div>
                  <div class="element-weight">{{ row.weight }}</div>
                </div>
                <div class="element-description">
                  {{ row.description }}
                  <span class="element-description-attribution"> -- Wikipedia </span>
                </div>
              </div>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns(); sticky: true"></tr>
          <tr
            mat-header-row
            *matHeaderRowDef="filterColumns(); sticky: true"
            [class.hidden]="!options().showFilter"
            class="filter-row"
          ></tr>

          <tr
            mat-row
            *matRowDef="let row; table: table; columns: displayedColumns()"
            class="summary-row"
            [class.expanded-row]="expandedElements.includes(row.name)"
            (click)="clickRow(row)"
          ></tr>
          <tr mat-row *matRowDef="let row; table: table; columns: ['expandedDetail']" class="detail-row"></tr>

          <tr class="mat-mdc-row" *matNoDataRow>
            <td class="mat-mdc-cell" [attr.colspan]="displayedColumns().length">
              <span style="margin-left: 1rem"> No data matching the filter "{{ input.value }}" </span>
            </td>
          </tr>
        </table>
      </ng-scrollbar>
      <span
        class="flex flex-row justify-between"
        style="padding-right: 1rem; padding-left: 1rem"
        [class.hidden]="!options().showPaginator && !options().showActions"
      >
        <div>
          <mat-paginator [pageSizeOptions]="[5, 10, 25, 100]" [class.hidden]="!options().showPaginator"></mat-paginator>
        </div>
        <span [class.hidden]="!options().showActions">
          <button mat-icon-button matTooltip="Add a record to this BE" color="primary">
            <mat-icon>add_circle</mat-icon>
          </button>
          <button mat-icon-button matTooltip="Save this BE" color="primary">
            <mat-icon>save</mat-icon>
          </button>
          <button mat-icon-button matTooltip="Download this BE" color="primary">
            <mat-icon>download</mat-icon>
          </button>
        </span>
      </span>
    </mat-sidenav-content>
  </mat-sidenav-container>
</section>

<pre>{{ store.$filter?.()?.getRawValue() | json }}</pre>
